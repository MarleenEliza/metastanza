{"version":3,"file":"tree.js","sources":["../../../home/runner/work/metastanza/metastanza/stanzas/tree/index.js"],"sourcesContent":["import Stanza from \"togostanza/stanza\";\n\nimport vegaEmbed from \"vega-embed\";\nimport loadData from \"@/lib/load-data\";\nimport { appendDlButton } from \"@/lib/metastanza_utils.js\";\n\nexport default class Tree extends Stanza {\n  async render() {\n    const css = (key) => getComputedStyle(this.element).getPropertyValue(key);\n\n    const vegaJson = await fetch(\n      \"https://vega.github.io/vega/examples/tree-layout.vg.json\"\n    ).then((res) => res.json());\n\n    //width,height,padding\n    const width = this.params[\"width\"];\n    const height = this.params[\"height\"];\n    const padding = this.params[\"padding\"];\n\n    //data\n    const labelVariable = this.params[\"label\"]; //\"name\"\n    const parentVariable = this.params[\"parent-node\"]; //\"parent\"\n    const idVariable = this.params[\"node\"]; //\"id-variable\"\n\n    const values = await loadData(\n      this.params[\"data-url\"],\n      this.params[\"data-type\"]\n    );\n\n    const data = [\n      {\n        name: \"tree\",\n        values,\n        transform: [\n          {\n            type: \"stratify\",\n            key: idVariable,\n            parentKey: parentVariable,\n          },\n          {\n            type: \"tree\",\n            method: { signal: \"layout\" },\n            size: [{ signal: \"height\" }, { signal: \"width - 100\" }],\n            separation: { signal: \"separation\" },\n            as: [\"y\", \"x\", \"depth\", \"children\"],\n          },\n        ],\n      },\n      {\n        name: \"links\",\n        source: \"tree\",\n        transform: [\n          { type: \"treelinks\" },\n          {\n            type: \"linkpath\",\n            orient: \"horizontal\",\n            shape: { signal: \"links\" },\n          },\n        ],\n      },\n    ];\n\n    //scales\n    const scales = [\n      {\n        name: \"color\",\n        type: \"ordinal\",\n        range: [\n          \"var(--togostanza-series-0-color)\",\n          \"var(--togostanza-series-1-color)\",\n          \"var(--togostanza-series-2-color)\",\n          \"var(--togostanza-series-3-color)\",\n          \"var(--togostanza-series-4-color)\",\n          \"var(--togostanza-series-5-color)\",\n        ],\n        domain: { data: \"tree\", field: \"depth\" },\n        zero: true,\n      },\n    ];\n\n    //marks\n    const marks = [\n      {\n        type: \"path\",\n        from: { data: \"links\" },\n        encode: {\n          update: {\n            path: { field: \"path\" },\n            stroke: { value: \"var(--togostanza-edge-color)\" },\n          },\n        },\n      },\n      {\n        type: \"symbol\",\n        from: { data: \"tree\" },\n        encode: {\n          enter: {\n            size: {\n              value: css(\"--togostanza-node-size\"),\n            },\n            stroke: { value: \"var(--stroke-color)\" },\n          },\n          update: {\n            x: { field: \"x\" },\n            y: { field: \"y\" },\n            fill: { scale: \"color\", field: \"depth\" },\n            stroke: { value: \"var(--togostanza-border-color)\" },\n            strokeWidth: { value: css(\"--togostanza-border-width\") },\n          },\n        },\n      },\n      {\n        type: \"text\",\n        from: { data: \"tree\" },\n        encode: {\n          enter: {\n            text: {\n              field:\n                this.params[\"label\"] === \"\"\n                  ? this.params[\"node\"]\n                  : labelVariable,\n            },\n            font: { value: css(\"--togostanza-font-family\") },\n            fontSize: { value: css(\"--togostanza-label-font-size\") },\n            baseline: { value: \"middle\" },\n          },\n          update: {\n            x: { field: \"x\" },\n            y: { field: \"y\" },\n            dx: { signal: \"datum.children ? -7 : 7\" },\n            align: { signal: \"datum.children ? 'right' : 'left'\" },\n            opacity: { signal: \"labels ? 1 : 0\" },\n            fill: { value: \"var(--togostanza-label-font-color)\" },\n          },\n        },\n      },\n    ];\n\n    const spec = {\n      $schema: \"https://vega.github.io/schema/vega/v5.json\",\n      width,\n      height,\n      padding,\n      signals: vegaJson.signals,\n      data,\n      scales,\n      marks,\n    };\n\n    //delete default controller\n    for (const signal of vegaJson.signals) {\n      delete signal.bind;\n    }\n\n    const el = this.root.querySelector(\"main\");\n    const opts = {\n      renderer: \"svg\",\n    };\n    await vegaEmbed(el, spec, opts);\n\n    //menu button placement\n    appendDlButton(\n      this.root.querySelector(\".chart-wrapper\"),\n      this.root.querySelector(\"svg\"),\n      \"tree\",\n      this.root\n    );\n\n    const menuButton = this.root.querySelector(\"#dl_button\");\n    const menuList = this.root.querySelector(\"#dl_list\");\n    switch (this.params[\"metastanza-menu-placement\"]) {\n      case \"top-left\":\n        menuButton.setAttribute(\"class\", \"dl-top-left\");\n        menuList.setAttribute(\"class\", \"dl-top-left\");\n        break;\n      case \"top-right\":\n        menuButton.setAttribute(\"class\", \"dl-top-right\");\n        menuList.setAttribute(\"class\", \"dl-top-right\");\n        break;\n      case \"bottom-left\":\n        menuButton.setAttribute(\"class\", \"dl-bottom-left\");\n        menuList.setAttribute(\"class\", \"dl-bottom-left\");\n        break;\n      case \"bottom-right\":\n        menuButton.setAttribute(\"class\", \"dl-bottom-right\");\n        menuList.setAttribute(\"class\", \"dl-bottom-right\");\n        break;\n      case \"none\":\n        menuButton.setAttribute(\"class\", \"dl-none\");\n        menuList.setAttribute(\"class\", \"dl-none\");\n        break;\n    }\n  }\n}\n"],"names":["vegaEmbed"],"mappings":"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"}